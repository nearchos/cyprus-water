<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quiz</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/cyprus_dams.css" type="text/css" rel="stylesheet" />
    <script src="js/APIUtils.js"></script>
    <script src="js/MeasurementUnit.js"></script>
    <script src="js/QuizClasses.js"></script>
    <script src="js/Cookies.js"></script>
    <script>
        //GLOBALS:
        var MEASUREMENT_UNITS = [];
        var ALL_QUESTIONS = [];
        var QUIZ;
        var currentQuestion;
        var selectedMeasurementIndex = 0;
        var currentQuestionIndex = 0;
    </script>
</head>
<body onload="getMeasurementUnits()">

<!-- NavBar -->
<div class="navbar-fixed">
    <nav>
        <div class="nav-wrapper blue darken-1">
            <a href="#" class="brand-logo center">Cyprus water</a>
            <ul id="nav-mobile" class="right hide-on-med-and-down">
            </ul>
        </div>
    </nav>
</div>

<div class="container">
    <div class="row">
        <h4 style="text-align: center;">Quiz</h4>
        <div class="col s12 m10 offset-m l8 offset-l2">
            <div class="card white">
                <div class="card-content blue-text text-darken-4" style="overflow: hidden; word-wrap: break-word;">


                    <div class="quizContainer" id="quizContainer" style="display: none;">
                        <span class="card-title">Question <span id="questionNumber"></span></span>
                        <p id="questionContent"></p>
                        <small id="sourceLabel"></small><small id="sourceContent"></small>

                        <p>
                            <label>
                                <input type="radio" name="answer" id="answerA" class="answer with-gap" onclick="document.getElementById('submitButton').style.visibility = 'visible'"/>
                                <span id="answerALabelAmount"></span><span style="font-size: 1rem;" id="answerALabelUnits"></span>
                            </label>
                        </p>

                        <p>
                            <label>
                                <input type="radio" name="answer" id="answerB" class="answer with-gap" onclick="document.getElementById('submitButton').style.visibility = 'visible'"/>
                                <span id="answerBLabelAmount"></span><span style="font-size: 1rem;" id="answerBLabelUnits"></span>
                            </label>
                        </p>

                        <p>
                            <label>
                                <input type="radio" name="answer" id="answerC" class="answer with-gap" onclick="document.getElementById('submitButton').style.visibility = 'visible'"/>
                                <span id="answerCLabelAmount"></span><span style="font-size: 1rem;" id="answerCLabelUnits"></span>
                            </label>
                        </p>

                        <p>
                            <label>
                                <input type="radio" name="answer" id="answerD" class="answer with-gap" onclick="document.getElementById('submitButton').style.visibility = 'visible'"/>
                                <span id="answerDLabelAmount"></span><span style="font-size: 1rem;" id="answerDLabelUnits"></span>
                            </label>
                        </p>

                        <br/>
                        <p style="text-align: center"><input class="btn blue darken-3" type="button" id="submitButton" value="Submit" style="visibility: hidden" onclick="submitAnswer()" /></p>
                        <br/>

                        <select id="measurementsSelection" style="display: block" onchange="measurementsSelection_Click();"></select>

                    </div>

                    <div class="waitContainer valign-wrapper" id="waitContainer">
                        <div style="text-align: center; width: 100%;">Please wait...</div>
                    </div>

            </div>
        </div>
    </div>

</div>



<script>

    function getMeasurementUnits() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState === 4 && this.status === 200) {
                var jsonObject = JSON.parse(this.responseText);
                for (var i = 0; i < jsonObject.length; i++) {
                    MEASUREMENT_UNITS.push(new MeasurementUnit(jsonObject[i].id, jsonObject[i].nameEl, jsonObject[i].nameEn, jsonObject[i].imageUrl, jsonObject[i].ratio));
                }
                getAllQuestions();
            }
        };
        xhttp.open("GET", API_MEASUREUNITS, true);
        xhttp.send();
    }

    function getAllQuestions() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState === 4 && this.status === 200) {
                var jsonObject = JSON.parse(this.responseText);
                var questionsObject = jsonObject.questions;
                //console.log(questionsObject);

                for (var i = 0; i < questionsObject.length; i++) {
                    //console.log(questionsObject[i].question);
                    var body = questionsObject[i].question;
                    var recommendedUnit = questionsObject[i].recommendedMeasureUnit;
                    var source = questionsObject[i].source;
                    var answersObject = questionsObject[i].answers;
                    var ANSWERS = [];

                    for (var j = 0; j < answersObject.length; j++) {
                        ANSWERS.push(new Answer(answersObject[j].answer, answersObject[j].correct));
                    }
                    ALL_QUESTIONS.push(new Question(body, ANSWERS, source, recommendedUnit));
                }
                initializeQuiz();
                document.getElementById("waitContainer").style.display = "none";
                document.getElementById("quizContainer").style.display = "block";
            }
        };
        xhttp.open("GET", API_QUIZ, true);
        xhttp.send();
    }

    function initializeQuiz() {

        //Check if the array contains questions:
        if (ALL_QUESTIONS.length < 1) {
            alert("Error. The quiz does not contain any questions.");
            document.location = "index.html";
            return;
        }

        //Create the quiz:
        QUIZ = new Quiz(ALL_QUESTIONS);

        selectedMeasurementIndex = getCookie(MEASURE_TYPE_COOKIE);
        if (selectedMeasurementIndex == "" || isNaN(selectedMeasurementIndex)) selectedMeasurementIndex = 0;


        getNextQuestion();

    }

    function getNextQuestion() {
        currentQuestionIndex++;
        currentQuestion = QUIZ.getNextQuestion();
        initializeComponents();
    }

    function initializeComponents() {
        //Initialize question components:
        var questionContent = document.getElementById("questionContent");
        questionContent.innerHTML = currentQuestion.question;

        //Question number:
        document.getElementById("questionNumber").innerHTML = currentQuestionIndex;

        updateUnitTags();

        //Initialize source label and content:
        if (currentQuestion.source !== "") {
            document.getElementById("sourceLabel").innerHTML = "Source:";
            var linkItem = document.createElement("a");
            linkItem.href = currentQuestion.source;
            linkItem.innerHTML = currentQuestion.source;
            document.getElementById("sourceContent").innerHTML = "";
            document.getElementById("sourceContent").appendChild(linkItem);
        }

        //Initialize the dropdown list:
        var measurementsSelection = document.getElementById("measurementsSelection");
        for (var i = 0; i < MEASUREMENT_UNITS.length; i++) {
            var newOptionItem = document.createElement("option");
            newOptionItem.innerHTML = MEASUREMENT_UNITS[i].nameEn;
            measurementsSelection.appendChild(newOptionItem);
        }

        //Set the measurement dropdown to the selected value:
        measurementsSelection.selectedIndex = selectedMeasurementIndex;

    }

    function updateUnitTags() {

        var originalA = currentQuestion.answers[0].answer;
        var originalB = currentQuestion.answers[1].answer;
        var originalC = currentQuestion.answers[2].answer;
        var originalD = currentQuestion.answers[3].answer;


        var convertedA = formatNumber(originalA / MEASUREMENT_UNITS[selectedMeasurementIndex].ratio);
        var convertedB = formatNumber(originalB / MEASUREMENT_UNITS[selectedMeasurementIndex].ratio);
        var convertedC = formatNumber(originalC / MEASUREMENT_UNITS[selectedMeasurementIndex].ratio);
        var convertedD = formatNumber(originalD / MEASUREMENT_UNITS[selectedMeasurementIndex].ratio);

        //Initialize answer components:
        document.getElementById("answerA").value = originalA;
        document.getElementById("answerB").value = originalB;
        document.getElementById("answerC").value = originalC;
        document.getElementById("answerD").value = originalD;

        //Initialize answer labels:
        //Amounts:
        document.getElementById("answerALabelAmount").innerHTML = convertedA;
        document.getElementById("answerBLabelAmount").innerHTML = convertedB;
        document.getElementById("answerCLabelAmount").innerHTML = convertedC;
        document.getElementById("answerDLabelAmount").innerHTML = convertedD;
        //Units:
        document.getElementById("answerALabelUnits").innerHTML = " " + MEASUREMENT_UNITS[selectedMeasurementIndex].nameEn + "s";
        document.getElementById("answerBLabelUnits").innerHTML = " " + MEASUREMENT_UNITS[selectedMeasurementIndex].nameEn + "s";
        document.getElementById("answerCLabelUnits").innerHTML = " " + MEASUREMENT_UNITS[selectedMeasurementIndex].nameEn + "s";
        document.getElementById("answerDLabelUnits").innerHTML = " " + MEASUREMENT_UNITS[selectedMeasurementIndex].nameEn + "s";
    }

    function measurementsSelection_Click() {
        selectedMeasurementIndex = measurementsSelection.selectedIndex;
        updateUnitTags();
    }

    const formatSeparators = (x) => { return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }

    function formatNumber(number) {
        console.log(number + typeof(number));
        //number = parseFloat(number.toFixed(4));
        return formatSeparators(number);
    }

    function submitAnswer() {

        const REWARD_POINTS = 10;

        //Find the answer:
        var answerElements = document.getElementsByClassName("answer");
        var userAnswerElement;
        for (var i = 0; i < answerElements.length; i++) {
            if (answerElements[i].checked) {
                userAnswerElement = answerElements[i];
                break;
            }
        }

        if (userAnswerElement == undefined) {
            alert("Please provide an answer.");
            return;
        }

        var answerStatus = QUIZ.answerQuestion(userAnswerElement.value);

        if (answerStatus._questionResult) {
            alert("Correct!");
        }
        else {
            var answers = currentQuestion.answers;
            var correctAnswer;
            for (var i = 0; i < answers.length; i++) {
                if (answers[i].correct) {
                    correctAnswer = answers[i];
                }
            }
            alert("Wrong. The correct answer was: " + correctAnswer.answer / MEASUREMENT_UNITS[selectedMeasurementIndex].ratio + ".");
        }

        if (answerStatus._questionResult) { //Correct, give points:
            if (getCookie(POINTS_COOKIE) === "" || isNan(getCookie(POINTS_COOKIE))) {
                setCookie(POINTS_COOKIE, 0);
            }
            var points = getCookie(POINTS_COOKIE);
            points += REWARD_POINTS;
            setCookie(POINTS_COOKIE, points);
        }

        if (answerStatus._endOfQuiz) {
            document.location = "insertName.html";
        }
        else {
            getNextQuestion();
        }

        //Uncheck radio buttons:
        var radioButtons = document.getElementsByClassName("answer");
        for (var i = 0; i < radioButtons.length; i++) {
            radioButtons[i].checked = false;
        }

    }

</script>

</body>
</html>